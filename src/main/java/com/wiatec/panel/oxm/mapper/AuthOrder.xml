<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wiatec.panel.oxm.dao.AuthOrderDao">
    <resultMap type="com.wiatec.panel.oxm.pojo.AuthOrderInfo" id="authOrderInfo">
        <id column="orderId" property="id"/>
        <id column="salesId" property="salesId"/>
        <result column="payClientKey" property="payClientKey"/>
        <result column="category" property="category"/>
        <result column="paymentId" property="paymentId"/>
        <result column="price" property="price"/>
        <result column="deposit" property="deposit"/>
        <result column="ldCommission" property="ldCommission"/>
        <result column="dealerCommission" property="dealerCommission"/>
        <result column="salesCommission" property="salesCommission"/>
        <result column="status" property="status"/>
        <result column="description" property="description"/>
        <result column="tradingTime" property="tradingTime"/>
        <association property="authSalesInfo" javaType="com.wiatec.panel.oxm.pojo.AuthSalesInfo">
            <id column="saleId" property="id"/>
            <result column="username" property="username"/>
            <result column="firstName" property="firstName"/>
            <result column="lastName" property="lastName"/>
            <result column="ssn" property="ssn"/>
            <result column="email" property="email"/>
            <result column="phone" property="phone"/>
            <result column="createTime" property="createTime"/>
        </association>
        <association property="authRentUserInfo" javaType="com.wiatec.panel.oxm.pojo.AuthRentUserInfo">
            <id column="userId" property="id"/>
            <result column="userSalesId" property="salesId"/>
            <result column="clientKey" property="clientKey"/>
            <result column="category" property="category"/>
            <result column="mac" property="mac"/>
            <result column="firstName" property="firstName"/>
            <result column="lastName" property="lastName"/>
            <result column="email" property="email"/>
            <result column="phone" property="phone"/>
            <result column="activateTime" property="activateTime"/>
            <result column="status" property="status"/>
            <result column="country" property="country"/>
            <result column="region" property="region"/>
            <result column="city" property="city"/>
            <result column="timeZone" property="timeZone"/>
            <result column="lastOnLineTime" property="lastOnLineTime"/>
        </association>
    </resultMap>

    <resultMap id="topVolumeInfo" type="com.wiatec.panel.oxm.pojo.chart.TopVolumeInfo">
        <id column="salesId" property="salesId"/>
        <result column="salesName" property="salesName"/>
        <result column="volume" property="volume"/>
    </resultMap>

    <resultMap id="topAmountInfo" type="com.wiatec.panel.oxm.pojo.chart.TopAmountInfo">
        <id column="salesId" property="salesId"/>
        <result column="salesName" property="salesName"/>
        <result column="amount" property="amount"/>
    </resultMap>

    <resultMap id="salesDaysCommissionInfo" type="com.wiatec.panel.oxm.pojo.chart.SalesDaysCommissionInfo">
        <result column="salesName" property="commission"/>
        <result column="amount" property="day"/>
    </resultMap>

    <resultMap id="salesMonthCommissionInfo" type="com.wiatec.panel.oxm.pojo.chart.SalesMonthCommissionInfo">
        <result column="salesName" property="commission"/>
        <result column="month" property="month"/>
    </resultMap>

    <sql id="select">SELECT auth_order.id orderId, auth_order.salesId, auth_order.payClientKey,
        auth_order.category, auth_order.paymentId, auth_order.price, auth_order.deposit,
        auth_order.ldCommission, auth_order.dealerCommission, auth_order.salesCommission,
        auth_order.status,auth_order.description, auth_order.tradingTime,
        auth_sales.id saleId, auth_sales.username, auth_sales.firstName, auth_sales.lastName,
        auth_sales.ssn, auth_sales.email, auth_sales.phone, auth_sales.createTime,
        auth_rent_user.id userId, auth_rent_user.salesId userSalesId, auth_rent_user.clientKey, auth_rent_user.category,
        auth_rent_user.mac, auth_rent_user.firstName, auth_rent_user.lastName, auth_rent_user.email,
        auth_rent_user.phone, auth_rent_user.activateTime, auth_rent_user.status, auth_rent_user.country,
        auth_rent_user.region, auth_rent_user.city, auth_rent_user.city, auth_rent_user.timeZone,
        auth_rent_user.lastOnLineTime
        FROM auth_order, auth_sales, auth_rent_user
        WHERE auth_order.salesId = auth_sales.id
        AND auth_order.payClientKey = auth_rent_user.clientKey
    </sql>


    <select id="selectOne" resultMap="authOrderInfo" parameterType="com.wiatec.panel.oxm.pojo.AuthOrderInfo">
        <include refid="select"/>
        WHERE payClientKey=#{payClientKey}
    </select>

    <select id="selectAll" resultMap="authOrderInfo">
        <include refid="select"/> ORDER BY tradingTime DESC
    </select>

    <select id="selectSaleVolumeEveryMonth" parameterType="Map" >
        SELECT auth_order.category, count(*) volume, count(category)
        FROM auth_order
        WHERE tradingTime BETWEEN '2017-11' AND '2017-12'
        GROUP BY auth_order.category
    </select>

    <select id="selectByTradingTime" resultMap="authOrderInfo" parameterType="String">
        <include refid="select"/>
        AND tradingTime like concat('%',#{_parameter},'%')
    </select>

    <select id="selectBySalesId" resultMap="authOrderInfo" parameterType="Integer">
        <include refid="select"/>
        AND auth_order.salesId=#{_parameter}
    </select>

    <select id="selectTopVolume" resultMap="topVolumeInfo" parameterType="int">
        SELECT s.salesId , COUNT(*) volume, auth_sales.username salesName
        FROM auth_order AS s, auth_sales
        WHERE s.salesId = auth_sales.id
        GROUP BY s.salesId
        ORDER BY volume DESC
        LIMIT #{_parameter};
    </select>

    <select id="selectTopAmount" resultMap="topAmountInfo" parameterType="int">
        SELECT salesId, sum(price) amount, auth_sales.username salesName
        FROM auth_order, auth_sales
        WHERE auth_order.salesId = auth_sales.id
        GROUP BY salesId
        ORDER BY amount DESC
        LIMIT #{_parameter};
    </select>

    <select id="getCommissionByMonth" parameterType="Map" resultMap="salesDaysCommissionInfo">
        SELECT sum(salesCommission) commission, DAYOFMONTH(tradingTime) day
        FROM auth_order
        <where>
            <if test="start != null and end != null">
                tradingTime BETWEEN #{start} AND #{end}
            </if>
            <if test="salesId != null">
                AND salesId=#{salesId}
            </if>
        </where>
        GROUP BY day
        ORDER BY day
    </select>

    <select id="getCommissionByYear" parameterType="Map" resultMap="salesMonthCommissionInfo">
        SELECT sum(salesCommission) commission, MONTH(tradingTime) month
        FROM auth_order
        <where>
            <if test="start != null and end != null">
                tradingTime BETWEEN #{start} AND #{end}
            </if>
            <if test="salesId != null">
                AND salesId=#{salesId}
            </if>
        </where>
        GROUP BY month
        ORDER BY month
    </select>

</mapper>